define(["modules/app","utils/convert","/js/lib/timetrack/timetrack.js"],function(a,b){function c(){setTimeout(d,1e3)}function d(){setTimeout(d,1e3),f!==0&&f!==i&&(console.log("Average time <",f,"ms>"),i=f)}function e(a){g+=a,h+=1,f=Math.ceil(g/h)}var f=0,g=0,h=0,i=0,j=4,k=2,l=k*j,m=$("head").attr("data-api"),n=a,o="grid:eventsReceived",p="searchResultsReceived",q=1440,r=function(a){var b=a.getUTCFullYear().toString()+"-"+("00"+(a.getUTCMonth()+1).toString()).slice(-2)+"-"+("00"+a.getUTCDate().toString()).slice(-2)+"T"+("00"+a.getUTCHours().toString()).slice(-2)+":00"+"Z";return b},s=function(a,b){var c=new Date(a.valueOf()),d=new Date(b.valueOf());c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0);var e=Math.floor(c.getHours()/j);c.setHours(e*j),d.setMinutes(60),d.setSeconds(0),d.setMilliseconds(0);var f=Math.ceil(d.getHours()/j);d.setHours(f*j);var g=[],h=j*60*60*1e3,i=new Date(c.valueOf()),k=new Date(c.valueOf()+h);do g.push([new Date(i.valueOf()),new Date(k.valueOf())]),i=new Date(i.valueOf()+h),k=new Date(k.valueOf()+h);while(k<=d);return g},t=function(a,b){var c=[],d=5,e=Math.ceil(a.length/d),f,g=r(b[0]),h=r(b[1]),i,j,k;for(f=0;f<e;f++)c[f]=a.slice(d*f,d*(f+1));i=c.length;for(f=0;f<i;f++){j=c[f];var l=(new Timer("getEventsForSliceFromApi Time Track")).off();k=m+"Channel/"+j.join("|")+"/events.json?qualifier=endDateTime%3E=@{timestamp%20"+g+"}%20and%20startDateTime%3C@{timestamp%20"+h+"}"+"&order=startDateTime&optionalProperties=Programme.subcategory&callback=?",$.getJSON(k,function(a){u(a,b,l)})}},u=function(a,b,c){c.track("API Response"),e(c.timeDiff);var d=[],f,g;$.isArray(a)&&a.length>0&&$.isArray(a[0])?$.each(a,function(a,b){d.push(b)}):d[0]=a,$.each(d,function(c,d){if(!d.length){console.log("Warning: eventsForChannel is an empty array"),console.log(a);return}g=d[0].channel.id,f=x(g,b),n.emit(o,d,f)})},v=function(a,b,c){var d=s(b,c),e=d.length,f;for(f=0;f<e;f++)t(a,d[f])},w=function(a){var b=m+"Event.json?query="+escape(a)+"&callback=?";$.getJSON(b,function(a){n.emit(p,[a])})},x=function(a,b){return a+"|"+b[0].valueOf()+"|"+b[1].valueOf()};return{getEventsForChannels:v,getEventsForSliceFromApi:t,getTimeSlices:s,formatTimeForApiRequest:r,getCacheKey:x}})