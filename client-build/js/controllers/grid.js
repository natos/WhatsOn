define(["config/grid","config/channel","modules/app","lib/flaco/controller","models/grid","models/channel","views/grid","utils/convert","utils/dom","utils/epgapi"],function(a,b,c,d,e,f,g,h,i,j){function k(){while(F.firstChild)F.removeChild(F.firstChild)}function l(){var b=0,c=E.length,d;for(b;b<c;b++)d=i.create("div"),d.id="cc_"+E[b].id,d.className="channel-container",d.style.top=b*a.ROW_HEIGHT+"px",H[E[b].id]=d,F.appendChild(d),d=null;G.id="timer-ticker",F.appendChild(G)}function m(a){console.log(a),a[b.SELECTED_GROUP]&&(E=f[b.GROUPS][f[b.SELECTED_GROUP]],k(),l(),g.render())}function n(b){C=r();var d=c.models.channel,f=d.groups[d.selected_group],g,h,i,j=e[a.CHANNEL_SLICE_CACHE];for(var k in f)f.hasOwnProperty(k)&&(g=f[k].id,h=C[g],i=B[g],i!==h&&(h?p(g,j):o(g)),i&&h?b&&b.length>0&&b[0].channel.id===g&&p(g,j):i&&!h?o(g):!i&&h&&p(g,j));B=C,e.set("render",F.cloneNode(!0))}function o(a){var b=H[a];while(b.firstChild)b.removeChild(b.firstChild)}function p(b,c){if(c){var d=j.getTimeSlices(a.ZERO,a.END),e,f,g,h;for(g=0;g<d.length;g++)f=d[g],e=j.getCacheKey(b,f),h=c[e],h&&q(b,h)}}function q(b,c){var d,e,f,g,j,k,l,m,n,o,p,q,r,s,t,u=H[b],v=50;for(d=0;d<c.length;d++){e=c[d],o=e.id;if(u.querySelectorAll("#event-"+o)[0])continue;q=e.programme.title,k=h.parseApiDateStringAsMilliseconds(e.startDateTime),l=h.parseApiDateStringAsMilliseconds(e.endDateTime),g=h.timeToPixels(k,a.ZERO),j=h.timeToPixels(l,a.ZERO),f=j-g;if(j<0)continue;g<0&&(j=g+f,g=0,f=j,q="←"+e.programme.title),p=e.programme.id,m=e.programme.subcategory.category.name,n=e.programme.subcategory.name,t=i.create("a"),t.id="event-"+o,t.className="grid-event"+(f<v?" tiny":""),t.href="/programme/"+p,t.style.width=f+"px",t.style.left=g+"px",t.setAttribute("data-category",m),t.setAttribute("data-subcategory",n),f>=v&&t.appendChild(document.createTextNode(q)),u.appendChild(t),t=null,q=null}}function r(){var c=e[a.SELECTED_CHANNELS],d=f[b.GROUPS][f[b.SELECTED_GROUP]],g={},h;for(var i in d)d.hasOwnProperty(i)&&(h=d[i].id,g[h]=c.indexOf(h)>=0);return g}function s(){return e.set(a.POSITION,{top:window.pageYOffset*-1,left:window.pageXOffset*-1}),z&&clearTimeout(z),z=setTimeout(t,A),this}function t(){e.set(a.SELECTED_CHANNELS,g.components.channelbar.getSelectedChannels(a.EXTRA_ABOVE_AND_BELOW)),e.set(a.SELECTED_TIME,g.getSelectedTime())}function u(b,c){var d;for(d=0;d<b.length;d++)delete b[d]._type,delete b[d].channel._type,delete b[d].channel.name,delete b[d].programme._type,delete b[d].programme.shortDescription,b[d].programme.subcategory&&(delete b[d].programme.subcategory._type,delete b[d].programme.subcategory.id,delete b[d].programme.subcategory.category._type,delete b[d].programme.subcategory.category.id),b[d].programme.category&&(delete b[d].programme.category._type,delete b[d].programme.category.id);return D[c]=b,n(b),e.set(a.CHANNEL_SLICE_CACHE,D),this}function v(){var a=e.selectedChannels,b=e.selectedTime.startTime,c=e.selectedTime.endTime,d=j.getTimeSlices(b,c),f=d.length,g=a.length,h,i,k,l;for(i=0;i<f;i++){l=[];for(h=0;h<g;h++)k=j.getCacheKey(a[h],d[i]),D[k]?u(D[k],k):l.push(a[h]);j.getEventsForSliceFromApi(l,d[i])}return this}function w(){return a.ZERO=a.zeroTime,a.END=new Date(a.zeroTime.valueOf()+864e5),l(),c.on(a.GRID_MOVED,s),c.on(a.GRID_FETCH_EVENTS,v),c.on(a.EVENTS_RECEIVED,u),c.on(b.MODEL_CHANGED,m),this}function x(){return k(),c.off(a.GRID_MOVED,s),c.off(a.GRID_FETCH_EVENTS,v),c.off(a.EVENTS_RECEIVED,u),c.off(b.MODEL_CHANGED,m),this}var y="grid",z,A=100,B={},C={},D={},E=f[b.GROUPS][f[b.SELECTED_GROUP]],F=i.create("fragment"),G=i.create("div"),H={};return new d({name:y,initialize:w,finalize:x,model:e,view:g})})